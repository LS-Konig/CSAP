---
title: |
  Code Notebook
subtitle: |
  How does reported partisan attachement influence affective polarization?: A comparative study of 25 European democracies
author:
  - name: Tristan Muno
    email: tristan.muno@uni-mannheim.de
    affiliations:
      - name: University of Mannheim
        department: School of Social Sciences
date: last-modified
date-format: MMMM D, YYYY
format:
  html:
    toc: true
    code-fold: true
    code-tools: true
    embed-resources: false
execute:
  echo: true
  warning: true
  eval: true
  message: true
---

# Setup

```{r}
#| label: setup

# To track render duration
start_time <- Sys.time()

# set width of console output
# options(width = 80)

# Install and load required packages
p_required <- c(
  "tidyverse",
  "here",
  "ggpubr",
  "gridExtra",
  "sessioninfo"
)
packages <- rownames(installed.packages())
p_to_install <- p_required[!(p_required %in% packages)]
if (length(p_to_install) > 0) {
  install.packages(p_to_install)
}
sapply(p_required, require, character.only = TRUE)
rm(p_required, p_to_install, packages)
```

# Load plot files

```{r}
#| label: load-models

load(here("data", "03_final", "plots", "plot_base_d.RData"))

load(here("data", "03_final", "plots", "plot_base_t.RData"))

load(here("data", "03_final", "plots", "plot_cov_d.RData"))

load(here("data", "03_final", "plots", "plot_cov_t.RData"))


load(here("data", "03_final", "plots", "plot_country_base_d.RData"))

load(here("data", "03_final", "plots", "plot_country_base_t.RData"))

load(here("data", "03_final", "plots", "plot_country_cov_d.RData"))

load(here("data", "03_final", "plots", "plot_country_cov_t.RData"))
```

# Pooled figures

## Base dictator game model

```{r}
#| label: fig-pooled-base-d
#| fig-cap: "Combined figure"
#| fig-dpi: 500
#| fig-width: 6.3
#| fig-height: 9

ggarrange(
  plot_base_d[["AP_Plot"]],
  plot_base_d[["IF_Plot"]],
  plot_base_d[["OD_Plot"]],
  nrow = 3
)

```

## Base trust game model

```{r}
#| label: fig-pooled-base-t
#| fig-cap: "Combined figure"
#| fig-dpi: 500
#| fig-width: 6.3
#| fig-height: 9

ggarrange(
  plot_base_t[["AP_Plot"]],
  plot_base_t[["IF_Plot"]],
  plot_base_t[["OD_Plot"]],
  nrow = 3
)

```

## Covariate dictator model

```{r}
#| label: fig-pooled-cov-d
#| fig-cap: "Pooled posterior distributions for AP, IF, and OD and the respective conditional average treatment effects in the dictator game. The figure displays pooled posterior estimates of three derived quantities --- affective polarization (AP), ingroup favoritism (IF), and outgroup derogation (OD) --- on the token outcome $Y_riac$ in the dictator game. Rows correspond to AP, IF, and OD. In each row the left panel shows the marginal posterior distirbutions by partisan type (explicit $T_i = 1$, implicit $T_i = 0$), and the right panel shows the corresponding Conditional Average Treatment Effect (CATE), i.e., the difference between explicit and implicit partisans for that quantity. All posterior quantities are obtained from the covariate-adjusted hierarchical model described in @sec-model using the observed-values approach (g-computation). The panels depict full posterior densities, points mark posterior medians, thick bars denote 95\\% credible intervals and thin bars denote 99\\% credible intervals."
#| fig-dpi: 500
#| fig-width: 6.3
#| fig-height: 8

ggarrange(
  plot_cov_d[["AP_Plot"]],
  plot_cov_d[["IF_Plot"]],
  plot_cov_d[["OD_Plot"]],
  nrow = 3
)

```

## Covariate trust model

```{r}
#| label: fig-pooled-cov-t
#| fig-cap: "Pooled posterior distributions for AP, IF, and OD and the respective conditional average treatment effects in the trust game. The figure displays pooled posterior estimates of three derived quantities --- affective polarization (AP), ingroup favoritism (IF), and outgroup derogation (OD) --- on the token outcome $Y_riac$ in the trust game. Rows correspond to AP, IF, and OD. In each row the left panel shows the marginal posterior distributions by partisan type (explicit $T_i = 1$, implicit $T_i = 0$), and the right panel shows the corresponding Conditional Average Treatment Effects (CATE), i.e., the difference between explicit and implicit partisans for that quantity. All posterior quantities are obtained from the covariate-adjusted hierarchical model described in @sec-model using the observed-values approach (g-computation). The curves depict full posterior densities, points mark posterior medians, thick bars denote 95\\% credible intervals and thin bars denote 99\\% credible intervals."
#| fig-dpi: 500
#| fig-width: 6.3
#| fig-height: 8

ggarrange(
  plot_cov_t[["AP_Plot"]],
  plot_cov_t[["IF_Plot"]],
  plot_cov_t[["OD_Plot"]],
  nrow = 3
)

```

# Country figures

## CATE Figures

### Base dictator game model

```{r}
#| label: fig-country-base-d-cate
#| fig-cap: "Country-specific CATEs for AP, IF, and OD in the dictator game. The figure displays country-specific posterior distributions of the Conditional Average Treatment Effects (CATEs) of explicit ($T_i = 1$) versus implicit ($T_i = 0$) partisanship on three derived quantities -- affective polarization (AP), ingroup favoritism (IF), and outgroup derogation (OD) -- measured on the token outcome $Y_riac$. Columns correspond to $CATE_{AP}$, $CATE_{IF}$, and $CATE_{OD}$, respectively. The y-axis lists countries and the x-axis reports effect sizes in tokens. Positive values indicate larger AP/IF/OD among explicit relative to implicit partisans within a country. All estimates are sampled from the covariate-adjusted hierarchical model (@sec-model) using the observed-values (g-computation) approach. For each country, we counstruct country-specific datasets that fix T and R to the focal values, generate posterior predictions including all random effects, and average over the observed distribution of covariates, respondents, and partisan anchors within that country. The curves depict full posterior densities, points mark posterior medians, thick bars denote 95\\% credible intervals and thin bars denote 99\\% credible intervals."
#| fig-dpi: 500
#| fig-width: 6.3
#| fig-height: 9
#| eval: false

plot_country_base_d$Country_CATE_Plot

```

### Base trust game model

```{r}
#| label: fig-country-base-t-cate
#| fig-cap: "Combined figure"
#| fig-dpi: 500
#| fig-width: 6.3
#| fig-height: 9
#| eval: false

plot_country_base_t$Country_CATE_Plot

```

### Covariate dictator model

```{r}
#| label: fig-country-cov-d-cate
#| fig-cap: "Country-specific CATEs for AP, IF, and OD in the dictator game. The figure displays country-specific posterior distributions of the Conditional Average Treatment Effects (CATEs) of explicit ($T_i = 1$) versus implicit ($T_i = 0$) partisanship on three derived quantities -- affective polarization (AP), ingroup favoritism (IF), and outgroup derogation (OD) -- measured on the token outcome $Y_riac$. Columns correspond to $CATE_{AP}$, $CATE_{IF}$, and $CATE_{OD}$, respectively. The y-axis lists countries and the x-axis reports effect sizes in tokens. Positive values indicate larger AP/IF/OD among explicit relative to implicit partisans within a country. All estimates are sampled from the covariate-adjusted hierarchical model (@sec-model) using the observed-values (g-computation) approach. For each country, we counstruct country-specific datasets that fix $T_i$ and $R_{ri}$ to the focal values, generate posterior predictions including all random effects, and average over the observed distribution of covariates, respondents, and partisan anchors within that country. The curves depict full posterior densities, points mark posterior medians, thick bars denote 95\\% credible intervals and thin bars denote 99\\% credible intervals."
#| fig-dpi: 500
#| fig-width: 6.3
#| fig-height: 8

plot_country_cov_d$Country_CATE_Plot +
  labs(x = "")

```

### Covariate trust model

```{r}
#| label: fig-country-cov-t-cate
#| fig-cap: "Country-specific CATEs for AP, IF, and OD in the trust game. The figure displays country-specific posterior distributions of the Conditional Average Treatment Effects (CATEs) of explicit ($T_i = 1$) versus implicit ($T_i = 0$) partisanship on three derived quantities -- affective polarization (AP), ingroup favoritism (IF), and outgroup derogation (OD) -- measured on the token outcome $Y_{riac}$. Columns correspond to $CATE_{AP}$, $CATE_{IF}$, and $CATE_{OD}$, respectively. The y-axis lists countries and the x-axis reports effect sizes in tokens. Positive values indicate larger AP/IF/OD among explicit relative to implicit partisans within a country. All estimates are sampled from the covariate-adjusted hierarchical model (@sec-model) using the observed-values (g-computation) approach. For each country, we counstruct country-specific datasets that fix $T_i$ and $R_{ri}$ to the focal values, generate posterior predictions including all random effects, and average over the observed distribution of covariates, respondents, and partisan anchors within that country. The curves depict full posterior densities, points mark posterior medians, thick bars denote 95\\% credible intervals and thin bars denote 99\\% credible intervals."
#| fig-dpi: 500
#| fig-width: 6.3
#| fig-height: 8

plot_country_cov_t$Country_CATE_Plot +
  labs(x = "")

```

## EV Figures

### Base dictator game model

```{r}
#| label: fig-country-base-d-ev
#| fig-cap: "Combined figure"
#| fig-dpi: 500
#| fig-width: 6.3
#| fig-height: 9

plot_country_base_d

```

### Base trust game model

```{r}
#| label: fig-country-base-t-ev
#| fig-cap: "Combined figure"
#| fig-dpi: 500
#| fig-width: 6.3
#| fig-height: 9

plot_country_base_t

```

### Covariate dictator model

```{r}
#| label: fig-country-cov-d-ev
#| fig-cap: "Country-specific posterior expected values by partisan type $T_i$ and relationship $R_{ri}$ in the dictator game. The figure plots country-specific posterior expected token allocations $E(Y_{riac})$ on the 0-10 scale, separatly by partisan type $T_i$ and partisan relationship $R_{ri}$. The x-axis shows the expected tokens, the y-axis lists countries. Columns split partisan type (left: explicit, $T_i = 1$; right: implicit, $T_i = 0$). Within each column, densities display the posterior distributions for the three relationship conditions $R_{ri} \\in {Co, Out, None}$. Larger separation between Co and Out within a country indicates greater affective polarization (AP). Comparisons across columns reveal how levels vary by partisan type within country. Estimates are obtained from the covariate-adjusted hierarchical model (@sec-model) using the observed-value (g-computation) approach. For each country, we construct country-specific datasets fixing $T_i$ and $R_{ri}$ to the focal values, generate posterior preditions including all random effects, and average over the observed distribution of covariates, respondents, and partisan anchors within that country. Distributions show full posterior densities, points mark posterior medians, thick and thin horizontal bars denote 95\\% and 99\\% credible intervals, respectively."
#| fig-dpi: 500
#| fig-width: 6.3
#| fig-height: 7.8

plot_country_cov_d$Combined_Country_EV_Plot

```

### Covariate trust model

```{r}
#| label: fig-country-cov-t-ev
#| fig-cap: "Country-specific posterior expected values by partisan type $T_i$ and relationship $R_{ri}$ in the trust game. The figure plots country-specific posterior expected token allocations $E(Y_{riac})$ on the 0-10 scale, separatly by partisan type $T_i$ and partisan relationship $R_{ri}$. The x-axis shows the expected tokens, the y-axis lists countries. Columns split partisan type (left: explicit, $T_i = 1$; right: implicit, $T_i = 0$). Within each column, densities display the posterior distributions for the three relationship conditions $R \\in {Co, Out, None}$. Larger separation between Co and Out within a country indicates greater affective polarization (AP). Comparisons across columns reveal how levels vary by partisan type within country. Estimates are obtained from the covariate-adjusted hierarchical model (@sec-model) using the observed-value (g-computation) approach. For each country, we construct country-specific datasets fixing $T_i$ and $R_{ri}$ to the focal values, generate posterior preditions including all random effects, and average over the observed distribution of covariates, respondents, and partisan anchors within that country. Distributions show full posterior densities, points mark posterior medians, thick and thin horizontal bars denote 95\\% and 99\\% credible intervals, respectively."
#| fig-dpi: 500
#| fig-width: 6.3
#| fig-height: 7.8

plot_country_cov_t$Combined_Country_EV_Plot

```

# Session Info

```{r}
#| label: session-info

session_info()
```


# Render Time

```{r}
#| label: render-time

end_time <- Sys.time()

rendering_time <- end_time - start_time

message(paste(
  "Document rendered in:",
  round(as.numeric(rendering_time, units = "secs"), 2),
  "seconds.
"
))
```